---
import { SITE, SOCIALS } from "@/config";

export interface Props {
  type: "BlogPosting" | "Person" | "WebSite";
  data: Record<string, any>;
}

const { type, data } = Astro.props;
const siteBase = SITE.website.endsWith("/") ? SITE.website : `${SITE.website}/`;
const defaultImage = new URL(SITE.ogImage ?? "og.png", siteBase).href;
const searchTarget = `${siteBase.replace(/\/$/, "")}/search?q={search_term_string}`;

const toAbsoluteUrl = (value?: string) => (value ? new URL(value, siteBase).href : defaultImage);

const sameAs = SOCIALS.filter(({ active, href }) => active && href.startsWith("http")).map(
  ({ href }) => href
);

const person = {
  "@type": "Person",
  name: SITE.author,
  url: SITE.profile || siteBase,
  image: defaultImage,
  ...(sameAs.length > 0 ? { sameAs } : {}),
  description: SITE.desc,
};

let structuredData: Record<string, any> = {};

if (type === "BlogPosting") {
  const publishedAt = data.pubDatetime?.toISOString?.() || data.pubDatetime;
  const modifiedAt = data.modDatetime?.toISOString?.() || publishedAt;
  const articleUrl = toAbsoluteUrl(data.url);

  structuredData = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: data.title,
    description: data.description || SITE.desc,
    author: {
      "@type": "Person",
      name: data.author || SITE.author,
      url: SITE.profile || siteBase,
    },
    datePublished: publishedAt,
    dateModified: modifiedAt,
    publisher: person,
    mainEntityOfPage: {
      "@type": "WebPage",
      "@id": articleUrl,
    },
    image: toAbsoluteUrl(data.ogImage),
    ...(data.tags?.length > 0
      ? {
          articleSection: data.tags[0],
          keywords: data.tags.join(", "),
        }
      : {}),
    ...(data.wordCount ? { wordCount: data.wordCount } : {}),
    ...(data.readingTime ? { timeRequired: data.readingTime } : {}),
  };
} else if (type === "Person") {
  structuredData = {
    "@context": "https://schema.org",
    ...person,
  };
} else if (type === "WebSite") {
  structuredData = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: SITE.title,
    url: siteBase,
    description: SITE.desc,
    author: {
      "@type": "Person",
      name: SITE.author,
      url: SITE.profile || siteBase,
    },
    potentialAction: {
      "@type": "SearchAction",
      target: searchTarget,
      "query-input": "required name=search_term_string",
    },
  };
}
---

<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
